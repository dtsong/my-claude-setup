# New Terraform Module Setup

Initialize a Terraform module with opinionated structure (tflint, tfsec, terraform-docs), testing, and environment strategy.

> For full convention details, see `~/.claude/skills/language-conventions/references/terraform.md`

## Stack

- **IaC**: Terraform 1.5+ (or OpenTofu)
- **Testing**: Native terraform test
- **Linting**: tflint, tfsec
- **Docs**: terraform-docs

## Setup Steps

1. Create module structure:
```bash
mkdir <module-name> && cd <module-name>
```

2. Create standard files:
```
main.tf          # Primary resources
variables.tf     # Input variables
outputs.tf       # Output values
versions.tf      # Provider/Terraform version constraints + backend
README.md        # Auto-generated by terraform-docs
```

3. Create `versions.tf` with commented backend example:
```hcl
terraform {
  required_version = ">= 1.5.0"

  required_providers {
    google = {
      source  = "hashicorp/google"
      version = "~> 5.0"
    }
    random = {
      source  = "hashicorp/random"
      version = "~> 3.6"
    }
  }

  # Uncomment and configure for remote state:
  # backend "gcs" {
  #   bucket = "<project>-tfstate"
  #   prefix = "<environment>/<stack>"
  # }
  #
  # AWS alternative:
  # backend "s3" {
  #   bucket = "<project>-tfstate"
  #   key    = "<environment>/<stack>/terraform.tfstate"
  #   region = "us-east-1"
  # }
}

provider "google" {
  project = var.project_id
  region  = var.region
}
```

4. Create `variables.tf`:
```hcl
variable "project_id" {
  description = "GCP project ID"
  type        = string
}

variable "region" {
  description = "GCP region for resources"
  type        = string
  default     = "us-central1"
}

variable "environment" {
  description = "Environment name (dev, staging, prod)"
  type        = string
  default     = "dev"

  validation {
    condition     = contains(["dev", "staging", "prod"], var.environment)
    error_message = "Environment must be dev, staging, or prod."
  }
}

variable "name" {
  description = "Name prefix for resources"
  type        = string
}

variable "labels" {
  description = "Labels to apply to all resources"
  type        = map(string)
  default     = {}
}
```

5. Create `outputs.tf`:
```hcl
output "id" {
  description = "The ID of the created resource"
  value       = null # Replace with actual resource reference
}
```

6. Create `terraform.tfvars.example`:
```hcl
# Copy to terraform.tfvars and fill in values
# NEVER commit terraform.tfvars (it's gitignored)

project_id  = ""
region      = "us-central1"
environment = "dev"
name        = "<project-name>"

labels = {
  environment = "dev"
  app         = "<project-name>"
  managed_by  = "terraform"
}
```

7. Create environment tfvars:
```
environments/
  dev.tfvars
  prod.tfvars
```

`environments/dev.tfvars`:
```hcl
environment = "dev"
# Add environment-specific overrides
```

`environments/prod.tfvars`:
```hcl
environment = "prod"
# Add environment-specific overrides
```

8. Create examples directory:
```
examples/
  complete/
    main.tf
    outputs.tf
```

9. Create tests directory:
```
tests/
  basic.tftest.hcl
```

10. Create `.pre-commit-config.yaml`:
```yaml
repos:
  - repo: https://github.com/antonbabenko/pre-commit-terraform
    rev: v1.96.0
    hooks:
      - id: terraform_fmt
      - id: terraform_validate
      - id: terraform_docs
      - id: terraform_tflint
      - id: terraform_tfsec
```

11. Create `.gitignore`:
```
.terraform/
*.tfstate*
*.tfvars
!terraform.tfvars.example
!environments/*.tfvars
```

12. Create project CLAUDE.md:
```markdown
# <Module Name> Terraform Module

## What This Is
<1-2 sentence description>

## Key Docs
- `README.md` â€” Auto-generated module documentation
- Convention reference: `~/.claude/skills/language-conventions/references/terraform.md`

## Quick Context
- IaC: Terraform 1.5+
- Provider: Google Cloud (or AWS)
- State: GCS backend (per-environment prefix)

## Tooling
- **terraform fmt** - Formatting (`terraform fmt -recursive`)
- **terraform validate** - Validation (`terraform validate`)
- **terraform test** - Testing (`terraform test`)
- **terraform-docs** - Documentation (`terraform-docs .`)
- **tflint** - Linting
- **tfsec** - Security scanning

## Key Decisions
- <Decision 1>

## Testing
- Native `terraform test` with `.tftest.hcl` files
- `terraform validate` in CI

## Git Workflow
- Plan on PR, apply on merge
- <Branch strategy>

## Current Focus
- <Current phase>
```

13. Initialize git:
```bash
git init
echo ".terraform/\n*.tfstate*\n*.tfvars\n!terraform.tfvars.example\n!environments/*.tfvars" > .gitignore
pre-commit install
git add .
git commit -m "chore: initial module setup"
```

## Verification

```bash
terraform fmt -check -recursive && terraform validate
```

## Best Practices Reference

The `terraform-skill` auto-activates when working with Terraform.
For comprehensive patterns, see `~/.claude/skills/language-conventions/references/terraform.md`
